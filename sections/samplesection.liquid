{% comment %}
  Sample Bundle Promo + 50ml Carousel (Handle-scoped, Dawn-compatible)
  Renders ONLY on: /products/build-your-own-discovery-set-5-x-2ml-sprays
{% endcomment %}

{% if template.name == 'product' and product and product.handle == 'build-your-own-discovery-set-5-x-2ml-sprays' %}
<section id="sample-bundle-50ml-{{ section.id }}" class="sample-50ml color-{{ section.settings.color_scheme }}">
  <div class="page-width">

    {% if section.settings.heading != blank %}
      <h2 class="sample-50ml__heading">{{ section.settings.heading | escape }}</h2>
    {% endif %}
    {% if section.settings.subheading != blank %}
      <p class="sample-50ml__subheading">{{ section.settings.subheading | escape }}</p>
    {% endif %}

    <div class="sample-50ml__banner">
      <div class="sample-50ml__banner-text">
        <strong class="sample-50ml__banner-title">{{ section.settings.banner_title | escape }}</strong>
        {% if section.settings.banner_text != blank %}
          <span class="sample-50ml__banner-copy">{{ section.settings.banner_text | escape }}</span>
        {% endif %}
      </div>
      {% if section.settings.bundle_handle != blank %}
        <a class="sample-50ml__banner-cta button"
           href="{{ routes.root_url }}products/{{ section.settings.bundle_handle | escape }}">
          {{ section.settings.banner_cta | default: 'Build your 5 x 2ml set' }}
        </a>
      {% endif %}
    </div>

    {% assign col = collections[section.settings.collection] %}
    {% if col and col.products_count > 0 %}
      <div class="sample-50ml__scroller-wrap">
        <button class="sample-50ml__nav sample-50ml__nav--prev" aria-label="Previous slide" type="button">
          <span aria-hidden="true">‹</span>
        </button>

        <div class="sample-50ml__scroller"
             data-autoplay="{{ section.settings.autoplay }}"
             data-interval="{{ section.settings.autoplay_ms }}">
          {% for p in col.products %}
            {% assign include_card = true %}

            {% if section.settings.filter_mode == 'title' and section.settings.filter_value != blank %}
              {% unless p.title contains section.settings.filter_value %}
                {% assign include_card = false %}
              {% endunless %}
            {% elsif section.settings.filter_mode == 'tag' and section.settings.filter_value != blank %}
              {% unless p.tags contains section.settings.filter_value %}
                {% assign include_card = false %}
              {% endunless %}
            {% endif %}

            {% if include_card %}
              <a class="sample-50ml__card" href="{{ p.url }}">
                {% if p.featured_image %}
                  <div class="sample-50ml__media">
                    <img
                      src="{{ p.featured_image | image_url: width: 600 }}"
                      alt="{{ p.featured_image.alt | escape }}"
                      loading="lazy"
                      width="300"
                      height="{{ 300 | divided_by: p.featured_image.aspect_ratio | round }}"
                    >
                  </div>
                {% endif %}
                <div class="sample-50ml__meta">
                  <div class="sample-50ml__title">{{ p.title }}</div>
                  {% if section.settings.show_price %}
                    <div class="sample-50ml__price">
                      {% render 'price', product: p, use_variant: true %}
                    </div>
                  {% endif %}
                </div>
              </a>
            {% endif %}
          {% endfor %}
        </div>

        <button class="sample-50ml__nav sample-50ml__nav--next" aria-label="Next slide" type="button">
          <span aria-hidden="true">›</span>
        </button>
      </div>
    {% else %}
      <p class="sample-50ml__empty">Please select a collection with products.</p>
    {% endif %}
  </div>

  <style>
    #sample-bundle-50ml-{{ section.id }}{
      --accent: {{ section.settings.accent | default: '#C7A86B' }}; /* gold accent */
      --muted: color-mix(in srgb, currentColor 60%, transparent);
      --card-border: rgba(0,0,0,0.08);
      padding: clamp(24px, 5vw, 56px) 0;
    }

    .sample-50ml__heading{
      font-size: clamp(22px, 3.2vw, 32px);
      line-height: 1.2;
      margin: 0 0 6px;
      text-align: center;
    }
    .sample-50ml__subheading{
      text-align: center;
      color: var(--muted);
      margin: 0 0 18px;
      font-size: clamp(14px, 2.2vw, 16px);
    }

    /* Mobile-proof banner layout */
    .sample-50ml__banner{
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
      background: #fff;
      border: 1px solid var(--card-border);
      border-radius: 14px;
      padding: 14px 16px;
      margin: 10px 0 18px;
    }
    .sample-50ml__banner-title{ font-size: 16px; }
    .sample-50ml__banner-copy{ color: var(--muted); font-size: 14px; }
    .sample-50ml__banner-cta{
      justify-self: end;
      background: var(--accent);
      border: 1px solid var(--accent);
      color: #111;
      font-weight: 600;
      padding: 10px 14px;
      border-radius: 10px;
      line-height: 1;
      min-width: 1px;
      text-align: center;
    }
    @media (max-width: 640px){
      .sample-50ml__banner{ grid-template-columns: 1fr; }
      .sample-50ml__banner-cta{ justify-self: stretch; width: 100%; }
    }

    .sample-50ml__scroller-wrap{
      position: relative;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .sample-50ml__scroller{
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: clamp(72%, 70vw, 240px); /* bigger cards on mobile */
      gap: 14px;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      padding: 4px;
      scrollbar-width: none; -ms-overflow-style: none;
    }
    .sample-50ml__scroller::-webkit-scrollbar{ display:none; }

    .sample-50ml__card{
      display: flex; flex-direction: column; gap: 8px; scroll-snap-align: start;
      background: #fff; border: 1px solid var(--card-border); border-radius: 14px;
      text-decoration: none; color: inherit; padding: 10px;
      transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .sample-50ml__card:hover{
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.06);
      border-color: color-mix(in srgb, var(--accent) 40%, #ddd);
    }

    .sample-50ml__media{ aspect-ratio: 1 / 1; overflow: hidden; border-radius: 10px; background: #f7f7f7; display:flex; }
    .sample-50ml__media img{ width:100%; height:100%; object-fit: cover; }

    .sample-50ml__meta{ display:flex; flex-direction: column; gap: 6px; }
    .sample-50ml__title{ font-size: 14px; line-height: 1.3; min-height: 36px; }
    .sample-50ml__price{ font-size: 14px; }

    /* Arrows: larger touch targets */
    .sample-50ml__nav{
      border: 1px solid var(--card-border);
      background: #fff;
      border-radius: 12px;
      width: 40px; height: 40px;
      display:grid; place-items:center;
      cursor:pointer;
      user-select: none;
      transition: border-color .2s ease, transform .1s ease;
    }
    .sample-50ml__nav:hover{ border-color: var(--accent); }
    .sample-50ml__nav:active{ transform: scale(0.98); }
    .sample-50ml__nav span{ font-size: 20px; line-height: 1; }

    @media (min-width: 990px){
      .sample-50ml__scroller{ grid-auto-columns: minmax(220px, 1fr); }
    }
  </style>

  <script>
    (function(){
      const root = document.getElementById('sample-bundle-50ml-{{ section.id }}');
      if(!root) return;
      const scroller = root.querySelector('.sample-50ml__scroller');
      const prev = root.querySelector('.sample-50ml__nav--prev');
      const next = root.querySelector('.sample-50ml__nav--next');
      if(!scroller) return;

      const cardWidth = () => scroller.querySelector('.sample-50ml__card')?.getBoundingClientRect().width || 240;

      let autoplay = scroller.dataset.autoplay === 'true';
      let interval = parseInt(scroller.dataset.interval || '3500', 10);
      let timer;

      function go(dir){
        scroller.scrollBy({ left: dir * (cardWidth() + 14), behavior: 'smooth' });
      }
      prev?.addEventListener('click', () => go(-1));
      next?.addEventListener('click', () => go(1));

      function start(){
        if(!autoplay) return;
        stop();
        timer = setInterval(() => {
          const max = scroller.scrollWidth - scroller.clientWidth - 2;
          if(scroller.scrollLeft >= max){ scroller.scrollTo({ left: 0, behavior: 'smooth' }); }
          else{ go(1); }
        }, interval);
      }
      function stop(){ if(timer) clearInterval(timer); }

      scroller.addEventListener('mouseenter', stop);
      scroller.addEventListener('mouseleave', start);
      scroller.addEventListener('touchstart', stop, { passive: true });
      scroller.addEventListener('touchend', start, { passive: true });

      start();
    })();
  </script>
</section>
{% endif %}

{% schema %}
{
  "name": "Sample Bundle + 50ml ",
  "class": "section",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Unsure which 50ml to purchase?" },
    { "type": "text", "id": "subheading", "label": "Subheading", "default": "Try five 2ml samples and discover your favourite." },

    { "type": "text", "id": "banner_title", "label": "Banner title", "default": "Sample Bundle" },
    { "type": "text", "id": "banner_text", "label": "Banner text", "default": "Build your own discovery set with any five fragrances in 2ml vials." },
    { "type": "text", "id": "banner_cta", "label": "Banner button text", "default": "Build your 5 x 2ml set" },
    { "type": "text", "id": "bundle_handle", "label": "Sample bundle product handle", "default": "build-your-own-discovery-set-5-x-2ml-sprays" },

    { "type": "collection", "id": "collection", "label": "Collection source" },
    { "type": "select", "id": "filter_mode", "label": "Filter mode", "default": "title", "options": [
      { "value": "none", "label": "No filter" },
      { "value": "title", "label": "Title contains" },
      { "value": "tag", "label": "Tag equals" }
    ]},
    { "type": "text", "id": "filter_value", "label": "Filter value (e.g. 50ml)", "default": "50ml" },

    { "type": "checkbox", "id": "show_price", "label": "Show price", "default": false },
    { "type": "checkbox", "id": "autoplay", "label": "Autoplay slider", "default": true },
    { "type": "range", "id": "autoplay_ms", "min": 2000, "max": 8000, "step": 250, "unit": "ms", "label": "Autoplay interval", "default": 3500 },

    { "type": "color_scheme", "id": "color_scheme", "label": "Color scheme", "default": "scheme-1" },
    { "type": "color", "id": "accent", "label": "Accent colour (gold)", "default": "#C7A86B" }
  ],
  "presets": [
    { "name": "Sample Bundle + 50ml Carousel (scoped)" }
  ]
}
{% endschema %}
